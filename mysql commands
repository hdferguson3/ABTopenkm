SELECT PSR_USER, PSR_NODE, PSR_FROM, @cur:= IF(PSR_NODE=@PSR_NODE, @cur+1, 1) AS RowNum, @PSR_NODE:= PSR_NODE  FROM OKM_PROP_SUB_RECEIVED WHERE PSR_FROM='jmcnaughton' ORDER BY PSR_NODE;

@cur:=IF(ACT_ITEM=@ACT_ITEM,@cur+1.0,1.0) AS RowNum,
     @ACT_ITEM:=ACT_ITEM,

SELECT
OKM_ACTIVITY.`ACT_DATE` AS OKM_ACTIVITY_ACT_DATE,
     OKM_PROP_SUB_RECEIVED.`PSR_USER` AS OKM_PROP_SUB_RECEIVED_PSR_USER,
     OKM_NODE_BASE.`NBS_NAME` AS OKM_NODE_BASE_NBS_NAME,
     OKM_NODE_DOCUMENT_VERSION.`NDV_NAME` AS OKM_NODE_DOCUMENT_VERSION_NDV_NAME,
     OKM_NODE_BASE.`NBS_UUID` AS OKM_NODE_BASE_NBS_UUID,
     OKM_PROP_SUB_RECEIVED.`PSR_NODE` AS OKM_PROP_SUB_RECEIVED_PSR_NODE,
     OKM_ACTIVITY.`ACT_ITEM` AS OKM_ACTIVITY_ACT_ITEM,
     OKM_ACTIVITY.`ACT_ACTION` AS OKM_ACTIVITY_ACT_ACTION,
     OKM_PROP_SUB_RECEIVED.`PSR_ACCEPTED` AS OKM_PROP_SUB_RECEIVED_PSR_ACCEPTED
FROM
     `OKM_PROP_SUB_RECEIVED` OKM_PROP_SUB_RECEIVED INNER JOIN `OKM_NODE_BASE` OKM_NODE_BASE ON OKM_PROP_SUB_RECEIVED.`PSR_NODE` = OKM_NODE_BASE.`NBS_UUID`
     INNER JOIN `OKM_NODE_DOCUMENT_VERSION` OKM_NODE_DOCUMENT_VERSION ON OKM_NODE_BASE.`NBS_UUID` = OKM_NODE_DOCUMENT_VERSION.`NDV_PARENT`
     INNER JOIN `OKM_ACTIVITY` OKM_ACTIVITY ON OKM_NODE_BASE.`NBS_UUID` = OKM_ACTIVITY.`ACT_ITEM`
WHERE
     PSR_FROM = 'jmcnaughton'
 AND NDV_CURRENT = 'T'
 AND PSR_NODE = ACT_ITEM
 AND ACT_USER = PSR_USER
 AND ACT_ACTION = 'GET_DOCUMENT_CONTENT'
 AND PSR_ACCEPTED='T'

ORDER BY
     PSR_USER ASC,
     NBS_NAME ASC,
     NDV_NAME ASC,
     ACT_DATE DESC



SELECT NSB_NODE, NBS_NAME FROM OKM_NODE_SUBSCRIPTOR inner join OKM_NODE_BASE on OKM_NODE_SUBSCRIPTOR.NSB_NODE = OKM_NODE_BASE.NBS_UUID where NBS_PARENT = '46209ab6-4629-4d39-978d-935f993fa3f8';

DELETE OKM_NODE_SUBSCRIPTOR FROM OKM_NODE_SUBSCRIPTOR inner join OKM_NODE_BASE on OKM_NODE_BASE.NBS_UUID = OKM_NODE_SUBSCRIPTOR.NSB_NODE =  where NBS_PARENT = '46209ab6-4629-4d39-978d-935f993fa3f8';

SELECT PSR_NODE, NBS_NAME FROM OKM_PROP_SUB_RECEIVED inner join OKM_NODE_BASE on OKM_NODE_BASE.NBS_UUID = OKM_PROP_SUB_RECEIVED.PSR_NODE where PSR_FROM ='jmcnaughton' and NBS_PARENT = '46209ab6-4629-4d39-978d-935f993fa3f8';

DELETE OKM_PROP_SUB_RECEIVED FROM OKM_PROP_SUB_RECEIVED inner join OKM_NODE_BASE on OKM_NODE_BASE.NBS_UUID = OKM_PROP_SUB_RECEIVED.PSR_NODE where PSR_FROM ='jmcnaughton' and NBS_PARENT = '46209ab6-4629-4d39-978d-935f993fa3f8';


